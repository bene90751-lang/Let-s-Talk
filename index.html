<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Let's Talk</title>
<style>
body { font-family: Arial; background:#121212; color:#fff; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
#chatContainer { width:400px; height:600px; border:2px solid #333; border-radius:10px; display:flex; flex-direction:column; background:#1e1e1e; }
#chatHeader { padding:15px; text-align:center; font-size:22px; font-weight:bold; border-top-left-radius:10px; border-top-right-radius:10px; background-color:#000; display:flex; justify-content:space-between; align-items:center; }
#messages { flex:1; padding:10px; overflow-y:auto; background:#1e1e1e; display:flex; flex-direction:column; gap:10px; }
.message { max-width:70%; padding:10px; border-radius:10px; word-wrap:break-word; position:relative; cursor:pointer; }
.message span { display:block; font-size:12px; margin-top:5px; color:#aaa; }
#inputArea { display:flex; padding:10px; background:#1e1e1e; border-bottom-left-radius:10px; border-bottom-right-radius:10px; gap:5px; }
#userInput { flex:1; padding:10px; border-radius:5px; border:none; font-size:14px; outline:none; background:#333; color:#fff; }
#sendBtn, #imageBtn, #voiceBtn { padding:10px 12px; border:none; border-radius:5px; background-color:#000; color:#fff; cursor:pointer; font-weight:bold; }
#sendBtn:hover, #imageBtn:hover, #voiceBtn:hover { background-color:#444; }
#senderSelect { padding:10px; border-radius:5px; border:none; background:#333; color:#fff; }
#typingIndicator { font-size:12px; color:#aaa; text-align:center; margin-bottom:5px; height:16px; }
img.chatImage { max-width:100%; border-radius:8px; margin-top:5px; }
audio { margin-top:5px; width:100%; }
</style>
</head>
<body>

<div id="chatContainer">
  <div id="chatHeader">
    <span>Let's Talk</span>
    <select id="senderSelect">
      <option value="Zee">Zee</option>
      <option value="Maria">Maria</option>
    </select>
  </div>
  <div id="typingIndicator"></div>
  <div id="messages"></div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="Type a message...">
    <button id="imageBtn">ðŸ“·</button>
    <button id="voiceBtn">ðŸŽ¤</button>
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  databaseURL: "https://let-s-talk-e57c6-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// DOM Elements
const messagesDiv = document.getElementById('messages');
const inputField = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const senderSelect = document.getElementById('senderSelect');
const typingIndicator = document.getElementById('typingIndicator');
const imageBtn = document.getElementById('imageBtn');
const voiceBtn = document.getElementById('voiceBtn');

// Typing indicator
let typingTimeout;
inputField.addEventListener('input', () => {
  const sender = senderSelect.value;
  db.ref('typing/' + sender).set(true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => db.ref('typing/' + sender).set(false), 1000);
});

// Listen typing
db.ref('typing').on('value', snap => {
  const typing = snap.val() || {};
  if (typing['Zee'] && senderSelect.value !== 'Zee') typingIndicator.textContent = 'Zee is typing...';
  else if (typing['Maria'] && senderSelect.value !== 'Maria') typingIndicator.textContent = 'Maria is typing...';
  else typingIndicator.textContent = '';
});

// Add message
function addMessage(id, sender, data) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message';
  msgDiv.dataset.id = id;

  if (sender === 'Zee') msgDiv.style.background = '#0077ff', msgDiv.style.alignSelf = 'flex-end';
  else msgDiv.style.background = '#00bb44', msgDiv.style.alignSelf = 'flex-start';

  const time = new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const date = new Date(data.timestamp).toLocaleDateString();

  // Determine content type
  let content = '';
  if (data.text) content += `<strong>${sender}:</strong> ${data.text}`;
  if (data.image) content += `<img class="chatImage" src="${data.image}">`;
  if (data.voice) content += `<audio controls src="${data.voice}"></audio>`;

  content += `<span>${date} ${time}</span>`;
  msgDiv.innerHTML = content;
  messagesDiv.appendChild(msgDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  // Long press for edit/delete
  let pressTimer;
  msgDiv.addEventListener('mousedown', () => { pressTimer = setTimeout(() => editMessage(id, data), 600); });
  msgDiv.addEventListener('mouseup', () => clearTimeout(pressTimer));
  msgDiv.addEventListener('mouseleave', () => clearTimeout(pressTimer));
}

// Send text message
function sendMessage() {
  const text = inputField.value.trim();
  if (!text) return;
  const sender = senderSelect.value;
  const timestamp = Date.now();
  db.ref('messages').push({ sender, text, timestamp });
  inputField.value = '';
}
sendBtn.addEventListener('click', sendMessage);
inputField.addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });

// Send image
imageBtn.addEventListener('click', () => {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const sender = senderSelect.value;
    const timestamp = Date.now();
    const storageRef = storage.ref('images/' + timestamp + '_' + file.name);
    storageRef.put(file).then(() => storageRef.getDownloadURL().then(url => {
      db.ref('messages').push({ sender, image: url, timestamp });
    }));
  };
  fileInput.click();
});

// Send voice note
voiceBtn.addEventListener('click', async () => {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Audio not supported"); return; }
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const mediaRecorder = new MediaRecorder(stream);
  const chunks = [];
  mediaRecorder.ondataavailable = e => chunks.push(e.data);
  mediaRecorder.onstop = async () => {
    const blob = new Blob(chunks, { type: 'audio/webm' });
    const sender = senderSelect.value;
    const timestamp = Date.now();
    const storageRef = storage.ref('voice/' + timestamp + '.webm');
    storageRef.put(blob).then(() => storageRef.getDownloadURL().then(url => {
      db.ref('messages').push({ sender, voice: url, timestamp });
    }));
  };
  mediaRecorder.start();
  setTimeout(() => mediaRecorder.stop(), 5000); // record 5s
});

// Edit message
function editMessage(id, data) {
  const newText = prompt("Edit your message:", data.text || "");
  if (newText === null) return; // cancel
  db.ref('messages/' + id).update({ text: newText });
}

// Listen messages
db.ref('messages').on('child_added', snap => addMessage(snap.key, snap.val().sender, snap.val()));
db.ref('messages').on('child_changed', snap => {
  // update message
  const msgDivs = document.querySelectorAll('.message');
  msgDivs.forEach(div => {
    if (div.dataset.id === snap.key) {
      div.querySelector('strong').nextSibling.textContent = ' ' + (snap.val().text || '');
    }
  });
});
db.ref('messages').on('child_removed', snap => {
  const msgDivs = document.querySelectorAll('.message');
  msgDivs.forEach(div => { if (div.dataset.id === snap.key) div.remove(); });
});
</script>
</body>
  </html>
