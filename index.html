<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Let's Talk</title>
<style>
body { font-family: Arial; background:#121212; color:#fff; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
#chatContainer { width:400px; height:600px; border:2px solid #333; border-radius:10px; display:flex; flex-direction:column; background:#1e1e1e; }
#chatHeader { padding:15px; text-align:center; font-size:22px; font-weight:bold; border-top-left-radius:10px; border-top-right-radius:10px; background-color:#000; display:flex; justify-content:space-between; align-items:center; }
#messages { flex:1; padding:10px; overflow-y:auto; background:#1e1e1e; display:flex; flex-direction:column; gap:10px; }
.message { max-width:70%; padding:10px; border-radius:10px; word-wrap:break-word; position:relative; }
.message span { display:block; font-size:12px; margin-top:5px; color:#aaa; }
#inputArea { display:flex; padding:10px; background:#1e1e1e; border-bottom-left-radius:10px; border-bottom-right-radius:10px; gap:5px; }
#userInput { flex:1; padding:10px; border-radius:5px; border:none; font-size:14px; outline:none; background:#333; color:#fff; }
#sendBtn { padding:10px 15px; border:none; border-radius:5px; background-color:#000; color:#fff; cursor:pointer; font-weight:bold; }
#sendBtn:hover { background-color:#444; }
#senderSelect { padding:10px; border-radius:5px; border:none; background:#333; color:#fff; }
#typingIndicator { font-size:12px; color:#aaa; text-align:center; margin-bottom:5px; height:16px; }
</style>
</head>
<body>

<div id="chatContainer">
  <div id="chatHeader">
    <span>Let's Talk</span>
    <select id="senderSelect">
      <option value="Zee">Zee</option>
      <option value="Maria">Maria</option>
    </select>
  </div>
  <div id="typingIndicator"></div>
  <div id="messages"></div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // ðŸ”¹ Initialize Firebase
  const firebaseConfig = {
    databaseURL: "https://let-s-talk-e57c6-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const messagesDiv = document.getElementById('messages');
  const inputField = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const senderSelect = document.getElementById('senderSelect');
  const typingIndicator = document.getElementById('typingIndicator');

  const MESSAGE_LIMIT = 1000; // keep last 1000 messages in DB

  // Add message to UI
  function addMessage(sender, text, timestamp) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';

    // Bubble colors
    if (sender === 'Zee') {
      msgDiv.style.background = '#0077ff';
      msgDiv.style.alignSelf = 'flex-end';
    } else {
      msgDiv.style.background = '#00bb44';
      msgDiv.style.alignSelf = 'flex-start';
    }

    const time = new Date(timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const date = new Date(timestamp).toLocaleDateString();

    msgDiv.innerHTML = `<strong>${sender}:</strong> ${text} <span>${date} ${time}</span>`;
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Send message
  function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;

    const sender = senderSelect.value;
    const timestamp = Date.now();

    db.ref('messages').push({ sender, text, timestamp });

    inputField.value = '';
    inputField.focus();
  }

  sendBtn.addEventListener('click', sendMessage);
  inputField.addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });

  // Typing indicator
  let typingTimeout;
  inputField.addEventListener('input', () => {
    const sender = senderSelect.value;
    db.ref('typing/' + sender).set(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      db.ref('typing/' + sender).set(false);
    }, 1000);
  });

  // Listen to new messages
  db.ref('messages').on('child_added', snapshot => {
    const msg = snapshot.val();
    addMessage(msg.sender, msg.text, msg.timestamp);

    // Limit messages to MESSAGE_LIMIT
    db.ref('messages').once('value', snap => {
      if (snap.numChildren() > MESSAGE_LIMIT) {
        const firstKey = Object.keys(snap.val())[0];
        db.ref('messages/' + firstKey).remove();
      }
    });
  });

  // Listen for typing
  db.ref('typing').on('value', snapshot => {
    const typing = snapshot.val() || {};
    if (typing['Zee'] && senderSelect.value !== 'Zee') {
      typingIndicator.textContent = 'Zee is typing...';
    } else if (typing['Maria'] && senderSelect.value !== 'Maria') {
      typingIndicator.textContent = 'Maria is typing...';
    } else {
      typingIndicator.textContent = '';
    }
  });

</script>
</body>
</html>
